<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DEAD ZONE REDUX - Fixed & Locked</title>
    <style>
        :root { --neon: #ff003c; --cyan: #00f2ff; --zombie: #39ff14; --bg: #020205; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; user-select: none; }
        
        .vhs-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 500;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%; opacity: 0.4;
        }

        #ui-layer { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 100; background: rgba(0,0,0,0.85); }
        .menu-card { background: #050508; padding: 40px; border: 1px solid #222; width: 450px; text-align: center; border-top: 3px solid var(--neon); box-shadow: 0 20px 50px rgba(0,0,0,1); }
        
        h1 { font-size: 32px; letter-spacing: 8px; margin: 0; text-shadow: 0 0 15px var(--neon); }
        .sub { color: var(--cyan); font-size: 10px; letter-spacing: 4px; margin-bottom: 30px; }

        button { 
            width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #333; 
            background: #000; color: #fff; cursor: pointer; font-size: 11px; 
            letter-spacing: 2px; text-transform: uppercase; transition: 0.2s;
        }
        button:hover:not(:disabled) { background: #fff; color: #000; box-shadow: 0 0 15px #fff; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

        .demo-msg { font-size: 11px; color: var(--zombie); margin: 20px 0; line-height: 1.6; border: 1px dashed var(--zombie); padding: 10px; }

        #hud { position: absolute; top: 30px; left: 30px; z-index: 50; }
        .hp-bar { width: 200px; height: 4px; background: #111; border: 1px solid #333; margin-top: 5px;}
        .hp-fill { height: 100%; background: var(--neon); box-shadow: 0 0 10px var(--neon); transition: 0.2s; }

        canvas { display: block; filter: contrast(1.1) brightness(1.1); }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin: 15px 0; }
    </style>
</head>
<body onclick="Snd.init()">
    <div class="vhs-overlay"></div>
    
    <div id="hud" class="hidden">
        <div style="font-size: 9px; letter-spacing: 2px;">VITAL SIGNS</div>
        <div class="hp-bar"><div id="hp-fill" class="hp-fill"></div></div>
    </div>

    <div id="ui-layer">
        <div id="m-main" class="menu-card">
            <h1>DEAD ZONE</h1>
            <div class="sub">CORE INTERFACE // V.10</div>
            <button onclick="ui.nav('m-campaign')">Campaign</button>
            <button onclick="ui.setMode('endless')">Endless Survival</button>
            <button onclick="localStorage.clear(); location.reload();">Reset Data</button>
        </div>

        <div id="m-campaign" class="menu-card hidden">
            <h1>SECTORS</h1>
            <div id="campaign-grid" class="grid"></div>
            <button onclick="ui.nav('m-main')">Return</button>
        </div>

        <div id="m-demo-end" class="menu-card hidden" style="border-top-color: var(--cyan)">
            <h1 style="color:var(--cyan)">LOCKED</h1>
            <div class="sub">ENCRYPTED DATA STREAM</div>
            <div class="demo-msg">
                MISSION 06-20 REQUIRE FULL VERSION.<br>
                UPLINK WITH PORTFOLIO TERMINAL TO UNLOCK.
            </div>
            <button onclick="window.top.location.href='index.html#home'">Return to Home</button>
            <button onclick="ui.nav('m-main')">Back to Menu</button>
        </div>

        <div id="m-class" class="menu-card hidden">
            <h1>LOADOUT</h1>
            <button onclick="game.launch('assault')">Assault (Rapid)</button>
            <button onclick="game.launch('tank')">Tank (Heavy)</button>
            <button onclick="ui.nav('m-campaign')">Cancel</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const Snd = {
        ctx: null, mg: null,
        init() {
            if (this.ctx) return;
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.mg = this.ctx.createGain(); this.mg.connect(this.ctx.destination);
        },
        osc(f, t, d, v, s=0) {
            if(!this.ctx) return;
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
            if(s) o.frequency.exponentialRampToValueAtTime(s, this.ctx.currentTime + d);
            g.gain.setValueAtTime(v, this.ctx.currentTime);
            g.gain.linearRampToValueAtTime(0, this.ctx.currentTime + d);
            o.connect(g); g.connect(this.mg);
            o.start(); o.stop(this.ctx.currentTime + d);
        }
    };

    const ui = {
        mission: 1, demoLimit: 5, mode: 'campaign',
        nav(id) {
            document.querySelectorAll('.menu-card').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'm-campaign') this.render();
        },
        render() {
            const container = document.getElementById('campaign-grid');
            container.innerHTML = '';
            for(let i=1; i<=20; i++) {
                const b = document.createElement('button');
                if(i > this.demoLimit) {
                    b.innerText = 'LOCK';
                    b.style.color = 'var(--neon)';
                    b.onclick = () => ui.nav('m-demo-end');
                } else {
                    b.innerText = i <= game.progress ? i : 'X';
                    b.disabled = i > game.progress;
                    b.onclick = () => { this.mission = i; this.mode = 'campaign'; ui.nav('m-class'); };
                }
                container.appendChild(b);
            }
        },
        setMode(m) { this.mode = m; ui.nav('m-class'); }
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.onresize = resize; resize();

    const game = {
        active: false, 
        progress: parseInt(localStorage.getItem('dz_redux_v10')) || 1,
        player: null, zombies: [], bullets: [], cameraX: 0, groundY: 0,

        launch(cls) {
            this.active = true; 
            this.groundY = canvas.height - 100;
            this.zombies = []; this.bullets = []; this.cameraX = 0;
            const stats = cls === 'assault' ? {hp:100, dmg:2, fire:150} : {hp:200, dmg:5, fire:400};
            this.player = { x: 200, y: this.groundY-70, vx:0, vy:0, ...stats, mHp: stats.hp, dir:1 };
            
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            this.loop();
        },

        update() {
            if(!this.active) return;
            const p = this.player;

            // Controls
            if(keys.KeyA) { p.vx -= 1.2; p.dir = -1; }
            if(keys.KeyD) { p.vx += 1.2; p.dir = 1; }
            if(keys.KeyW && p.y >= this.groundY - 71) { p.vy = -16; Snd.osc(200, 'sine', 0.1, 0.1); }
            
            p.vx *= 0.85; p.vy += 0.8; p.x += p.vx; p.y += p.vy;
            if(p.y > this.groundY - 70) { p.y = this.groundY - 70; p.vy = 0; }

            this.cameraX += (p.x - canvas.width/3 - this.cameraX) * 0.1;

            // Shooting
            if(keys.Space && Date.now() - (p.lastShot||0) > p.fire) {
                this.bullets.push({x: p.x + (p.dir*20), y: p.y+25, vx: p.dir*30});
                p.lastShot = Date.now();
                Snd.osc(400, 'square', 0.1, 0.1);
            }

            // Spawn Zombies
            if(Math.random() < 0.03) {
                this.zombies.push({x: p.x + canvas.width, hp: 5 + ui.mission});
            }

            // Bullet Logic
            this.bullets.forEach((b, bi) => {
                b.x += b.vx;
                this.zombies.forEach((z, zi) => {
                    if(Math.abs(b.x - z.x) < 40) {
                        z.hp -= p.dmg; this.bullets.splice(bi, 1);
                        if(z.hp <= 0) this.zombies.splice(zi, 1);
                    }
                });
            });

            // Zombie Logic
            this.zombies.forEach(z => {
                z.x -= 2;
                if(Math.abs(p.x - z.x) < 30) { p.hp -= 0.5; }
            });

            // WIN / LOSE CONDITIONS (The Fix is here)
            const goal = 2000 + (ui.mission * 1000);
            
            if(ui.mode === 'campaign' && p.x > goal) {
                this.stop(); // Stop the loop!
                if(ui.mission === ui.demoLimit) {
                    ui.nav('m-demo-end');
                } else {
                    if(ui.mission === this.progress) {
                        this.progress++;
                        localStorage.setItem('dz_redux_v10', this.progress);
                    }
                    ui.nav('m-campaign');
                }
            }

            if(p.hp <= 0) {
                this.stop();
                alert("MISSION FAILED - VITALS ZERO");
                location.reload();
            }

            document.getElementById('hp-fill').style.width = (p.hp/p.mHp*100) + '%';
        },

        draw() {
            if(!this.active) return;
            ctx.fillStyle = '#020205'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(-this.cameraX, 0);
            
            // Ground
            ctx.fillStyle = '#0a0a0f'; ctx.fillRect(0, this.groundY, 10000, 100);
            ctx.fillStyle = '#ff003c'; ctx.globalAlpha = 0.2; ctx.fillRect(0, this.groundY, 10000, 2); ctx.globalAlpha = 1;

            // Player
            ctx.fillStyle = '#fff'; ctx.shadowBlur = 15; ctx.shadowColor = '#00f2ff';
            ctx.fillRect(this.player.x, this.player.y, 30, 70);

            // Zombies
            ctx.shadowColor = '#39ff14'; ctx.fillStyle = '#000'; ctx.strokeStyle = '#39ff14';
            this.zombies.forEach(z => {
                ctx.fillRect(z.x, this.groundY-70, 30, 70);
                ctx.strokeRect(z.x, this.groundY-70, 30, 70);
            });

            // Bullets
            ctx.fillStyle = '#00f2ff';
            this.bullets.forEach(b => ctx.fillRect(b.x, b.y, 20, 2));

            ctx.restore();
        },

        stop() {
            this.active = false;
            document.getElementById('hud').classList.add('hidden');
        },

        loop() { 
            if(!this.active) return; 
            this.update(); 
            this.draw(); 
            requestAnimationFrame(() => this.loop()); 
        }
    };

    const keys = {}; window.onkeydown = e => keys[e.code] = true; window.onkeyup = e => keys[e.code] = false;
</script>
</body>
</html>
